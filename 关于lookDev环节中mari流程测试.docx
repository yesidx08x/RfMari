关于lookDev环节中Mari流程如何引入和衔接的若干测试
灯光环境的匹配问题：
这里主要是测试Mari中HDR照明效果与randerman(以下简称RM)及mantra的渲染效果是否可以统一.首先创建一个简单场景,我将其导入mari,并赋予一个50%灰度的漫反射材质,然后创建HDR灯光,得到的实时显示效果如下:
 
之后再同时使用RM和mantra渲染,并调整HDR照明的强度,得到比较接近的效果如下:
               RM                                   mantra
   
目前的照明强度参数分别Mari为1.1 ,RM为0.45 ,mantra为1.5 ,可以看出数值之间并不一致（而且在之后的测试中还发现在Mari中不同的材质对于漫反射的表现也有差别，故该套参数只能套用于Mari的VRay\RM的LMLayer\mantra的mantraSurface这一套材质）, 所以需在制作前使用灰色材质进行强度校正来达到较为匹配的效果, 由于mari的照明效果中是不显示物体间阴影的, 在匹配时需要对应的是物体亮部和非阴影暗部的明度,而且也可以发现两个渲染器之间对于环境溢色和暗部亮度的表现是存在有细微的差距.
但在HDR图光照信息较好的前提下,总体效果仍在可控的范围之内.

Shader匹配度的问题：
由于Mari中没有内置RM和mantra的shader,于是只能尝试从现在有的shader中找出和两个渲染器都能基本对应的其他shader.
筛选后在3个软件选出两组对应的材质球,两组材质由于底层计算方式有较大差别,对贴图的需求会不一样,一组是Mari的unreal\RM的disney\mantra的principled,这3个材质球的属性基本一致;另一组是Mari的VRay\RM的LMLayer\mantar的mantraSurface.   
两组材质在贴图制作思路和对金属质感的表现方面有一定差别,所以在实际生产中具体使用哪组材质和如何使用之后会分开来再讨论,下面只看每组材质的表现效果是否能统一和如何统一这一问题.
基于这个测试目的我制作了一个混合了多种材质的小道具,来观察测试结果.
首先是Mari的unreal\RM的disney\mantra的principled
基于这3个材质将HDR的照明数值匹配为Mari 1.4 ,RM 0.45 ,mantra 1.5
这3个材质都使用了color、metallic、specular、roughness、bump、displacement这6张序列贴图，贴图效果如下（每个序列选取第一象限作为示例）：
 
Mari的unreal实时显示效果如下:  




RM的disney渲染效果如下:
 
可以明显看到两个显示效果间存在差异，在受环境色影响时unreal受影响更多些，两者对金属质感的表现也有所不同，但是对于细节的呈现和材质质感的区分度上还是都能做到不错的效果，这种匹配度的误差在实际生产中是否能够接受现在还不好说。 
mantra的principled渲染效果如下：
 
除了仍然在金属质感上稍有差距，其余和RM的渲染结果基本接近，但是虽然mantra和RM的效果基本一致，但是它们和Mari间确实仍有差别。
所以这组材质目前看来应该可以进入生产，软件间的差异可以通过在Mari里添加调整层来进行微调，但是微调这步就无法以Mari的显示效果为准，只能每次调整后进入渲染器来判断最终效果。

接下来是Mari的VRay\RM的LMLayer\mantra的mantraSurface
这组材质的对应关系比较复杂，下面会简单解释一下。
首先由于RM的LMLayer材质较为特殊，是通过折射率refractive index来控制金属质感(也可理解为镜面反射效果)，且该参数为一个大于1的数值：
refractive index值分别为1.5、2.5、5.0时的质感表现
   
这就意味着如果需要得到金属质感（尤其是镜子、铬、不锈钢等）必需要调整该参数，在这种情况下只能使用Mari内置的VRay材质，因为VRay材质上刚好有一个Fresnel IOR属性与之相对应，当Fresnel IOR与refractive index数值相同时，两个材质具有相同的质感表现。但是比较尴尬的是这一参数上Mari里没有提供连接贴图的功能，同时Mari也没有办法直接绘制大于1的贴图。
相应的，mantra的mantraSurface并没有这一参数，而是通过它的metallic来强化金属质感（此metallic与上一组测试中的metallic是非常不同的两个概念，这里的metallic仅为控制反射的效果（其实更准确的说也是菲涅尔的效果），而上一组中的metallic则是一个物理性的属性，将材质的diffuse强度、高光颜色及菲涅尔现象等混合为一个参数进行控制）。





metallic值分别为0.0、0.2、0.5时的质感表现
   
也就是说在应对复合材质时，RM的LMLayer无法在实现一个shader解决所有质感表现的效果，必须要用到层材质的功能；而mantra的mantraSurface虽然可以整合为一个材质，但是需要单独对其metallic属性出图来控制，且这个图的控制效果无法在Mari里直 观看到（因为没有这个属性），只能把Mari当作可以处理序列图的PS来制作这张图，最后返回渲染器中进行测试。

那么接下来首先忽略这几个麻烦的属性来进行测试，基于这3个材质将HDR的照明数值匹配为Mari 1.1 ,RM 0.45 ,mantra 1.5，所有材质球目前都用到了color、specular、roughness、bump、displacement这五张序列贴图，贴图效果如下（每个序列仍选取第一象限作为示例）：
 
    可以看到clr图和上一组的在金属部分有所差别，这和这两组材质在算法上的区别有关。
为了更直观的表现质感，在下面的渲染测试中关掉了color层：






Mari的VRay实时显示效果如下:
 

RM的LMLayer渲染效果如下:
 
可以看到，当我将Fresnel IOR和refractive index调到相同参数（2.5）时，两者除了圆球下半部分的菲涅尔略有差别，其余的质感差别不大，基本还是能做到匹配。





mantra的mantraSurface渲染效果如下:
 
     为了匹配refractive index值为2.5时的质感表现，我将mantraSurface的metallic值调至0.13，如果不调整这个参数，则会因为菲涅尔的效果不同导致没法得到相应的金属质感。
     下面将color层打开再进行一次渲染 ：
           VRay                    LMLayer                mantraSurface
   

目前看来匹配度还算良好，但是，很多情况下我们需要更强烈的金属或非金属质感表现，那么如果同用一个refractive index（或是Fresnel IOR、metallic）参数，就会造成质感区分不如我们想要的那么明确，而这个问题只能针对不同的渲染器来解决。
对于LMLayer解决以上问题还是需要依靠叠加层材质来实现，对需要区分和强化的材质部分制作一张mask（在Mari内制作，利用原有的贴图层调整得到），这里我对圆球上半部分和底座上的格子这两处金属制作mask：

  
通过这个mask连接一个一样的LMLayer，只对这个新的层里的refractive index进行调整（调至5.0），得到下面的渲染效果：
            添加了一层材质                           未添加层材质
  
可以看到添加层材质后得到了一个反射更强的金属质感。

对于mantraSurface解决以上问题则需要单独制作一张metallic贴图（同样在Mari内制作，利用原有的贴图层调整得到），贴图的形式如下：
 
将贴图连到mantraSurface的metallic属性上，渲染得到如下结果：


添加metallic贴图                   未添加metallic贴图
  
同样的，通过添加metallic，最终得到了一个更强反射的金属质感。

结论
最后可以看出在lookdev中使用Mari流程基本还是可以的，尤其是在非强反射金属质感以外的表现上可以一定程度上对接我们目前使用的两款渲染器。
但是毕竟由于不是完美对接,在制作的过程中需要制作人员具有一定的分析能力和解决经验，运用一些小技巧来平衡Mari与渲染效果间的差别，有时甚至需要一些“脑补”，提前预判如何在mari中调整贴图可以得到我们想要的渲染结果。尽管这样，mari在面对多质感混合和多UV象限物体时确实具备一定的制作优势，在项目制作中会依资产的特点逐步在组内普及并有针对性地使用。

